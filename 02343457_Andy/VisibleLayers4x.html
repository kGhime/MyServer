<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Layers Test - JS API 4.11</title>

  <style>
    html,
    body,
    #mapView {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/themes/light/main.css?a=1" />
  <script src="https://js.arcgis.com/4.10/"></script>

  <script>
    require([ "esri/config", "esri/geometry/SpatialReference", "esri/geometry/Extent", "esri/Map", "esri/views/MapView", "esri/layers/MapImageLayer" ], 
	function( esriConfig, SpatialReference, Extent, Map, MapView, MapImageLayer ) 
	{
		var app = {};	
	 
        esriConfig.request.proxyUrl = "proxy/proxy.ashx";
        
        app.spatialRefNAD83 = new SpatialReference(2276);
		
        app.defaultExtent = new Extent({xmin: 2404126.87277272, ymin: 6949462.94649532, xmax: 2406818.24810101, ymax: 6951530.81987256, spatialReference: app.spatialRefNAD83 });
		
		app.urlMapImgLyrUtilMap = "http://wtr-dev:6080/arcgis/rest/services/WaterUtilities/UtilMap/MapServer";
		
        app.mapImgLyrUtilMap = new MapImageLayer({
            url: app.urlMapImgLyrUtilMap,
            visible: false
        });

        app.map = new Map({
			layers: [app.mapImgLyrUtilMap] 
        });

        app.mapView = new MapView({
            container: "mapView",
            map: app.map
        });
        app.mapView.extent = app.defaultExtent;


        app.mapImgLyrUtilMap.when(function () {
		
			//This redraws fine
			app.mapImgLyrUtilMap.sublayers = [ { id: 11, visible: true } ];
		
			//This fails to redraw these layers after initially drawing on load
            app.mapImgLyrUtilMap.sublayers = [ { id: 11, visible: true }, { id: 12, visible: true }, { id: 13, visible: true } ];
		
            app.mapImgLyrUtilMap.visible = true;

        }, function (error) {
            console.log("map image layer failed to load: ", error);
        });

    });
  </script>
</head>


<body>
  <div id="mapView"></div>
</body>
</html>